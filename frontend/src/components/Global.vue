<template>
    <n-layout>
        <n-layout-header>
            <n-grid :cols="8">
                <n-gi class="menu" style="grid-column: span 4 / span 4;">
                    <n-icon size="40">
                        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg"
                            xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 508 508" xml:space="preserve">
                            <circle style="fill:#90DFAA;" cx="254" cy="254" r="254" />
                            <path style="fill:#2C9984;"
                                d="M53.2,409.2C99.6,469.2,172.4,508,254,508s154.4-38.8,200.8-98.8H53.2z" />
                            <path style="fill:#324A5E;" d="M105.2,309.2v60.4c0,12.4,10,22,22,22h277.6c4.8,0,8.8,4,8.8,8.8l0,0c0,4.8-4,8.8-8.8,8.8H127.2
                        c-22,0-39.6-17.6-39.6-39.6v-60.4c0-22,17.6-39.6,39.6-39.6h277.6c4.8,0,8.8,4,8.8,8.8l0,0c0,4.8-4,8.8-8.8,8.8H127.2
                        C115.2,286.8,105.2,296.8,105.2,309.2z" />
                            <path style="fill:#FFFFFF;" d="M398.8,339.2c0,20,2.8,38.4,7.2,52.4H127.2c-12.4,0-22-10-22-22v-60.4c0-12,10-22,22-22H406
                        C401.2,300.8,398.8,319.2,398.8,339.2z" />
                            <g>
                                <path style="fill:#E6E9EE;"
                                    d="M402.4,301.2c-0.4,0.8-0.4,2-0.4,3.2H106c0.4-1.2,0.4-2,0.8-3.2H402.4z" />
                                <path style="fill:#E6E9EE;" d="M400,315.6c0,0.8-0.4,2-0.4,3.2H105.2v-3.2H400z" />
                                <path style="fill:#E6E9EE;" d="M398.8,330.4c0,1.2,0,2,0,3.2H105.2v-3.2H398.8z" />
                                <path style="fill:#E6E9EE;"
                                    d="M398.8,348H105.2v-3.2h293.6C398.8,346,398.8,347.2,398.8,348z" />
                                <path style="fill:#E6E9EE;"
                                    d="M400,362.8H105.2v-3.2h294.4C399.6,360.8,400,362,400,362.8z" />
                                <path style="fill:#E6E9EE;"
                                    d="M402.4,377.6H106.8c-0.4-0.8-0.8-2-0.8-3.2h296C402,375.6,402,376.4,402.4,377.6z" />
                            </g>
                            <path style="fill:#FF7058;" d="M83.2,191.6v46.8c0,9.6,7.6,17.2,17.2,17.2h214.8c3.6,0,6.8,3.2,6.8,6.8l0,0c0,3.6-3.2,6.8-6.8,6.8
                        H100.4c-16.8,0-30.8-13.6-30.8-30.8v-46.8c0-16.8,13.6-30.8,30.8-30.8h214.8c3.6,0,6.8,3.2,6.8,6.8l0,0c0,3.6-3.2,6.8-6.8,6.8H100.4
                        C90.8,174.8,83.2,182.4,83.2,191.6z" />
                            <path style="fill:#FFFFFF;" d="M310.4,215.2c0,15.6,2,29.6,5.6,40.4H100.4c-9.6,0-17.2-7.6-17.2-17.2v-46.8
                        c0-9.6,7.6-17.2,17.2-17.2h215.2C312.4,185.6,310.4,199.6,310.4,215.2z" />
                            <g>
                                <path style="fill:#E6E9EE;"
                                    d="M312.8,185.6c0,0.8-0.4,1.6-0.4,2.4H83.6c0-0.8,0.4-1.6,0.8-2.4H312.8z" />
                                <path style="fill:#E6E9EE;" d="M311.2,196.8c0,0.8,0,1.6-0.4,2.4H83.2v-2.4H311.2z" />
                                <path style="fill:#E6E9EE;" d="M310.4,208.4c0,0.8,0,1.6,0,2.4H83.2v-2.4H310.4z" />
                                <path style="fill:#E6E9EE;"
                                    d="M310.4,222H83.2v-2.4h227.2C310.4,220.4,310.4,221.2,310.4,222z" />
                                <path style="fill:#E6E9EE;"
                                    d="M311.2,233.2h-228v-2.4h227.6C311.2,232,311.2,232.8,311.2,233.2z" />
                                <path style="fill:#E6E9EE;"
                                    d="M312.8,244.8H84.4c-0.4-0.8-0.4-1.6-0.8-2.4h228.8C312.8,243.2,312.8,244,312.8,244.8z" />
                            </g>
                            <rect x="312.343" y="198.873"
                                transform="matrix(-0.7071 0.7071 -0.7071 -0.7071 696.2315 143.7574)" style="fill:#2B3B4E;"
                                width="12" height="34.4" />
                            <circle style="fill:#324A5E;" cx="260.4" cy="158" r="83.2" />
                            <circle style="fill:#84DBFF;" cx="260.4" cy="158" r="66.4" />
                            <path style="fill:#FFFFFF;" d="M334.4,219.6L322,232c-2,2-2,5.6,0,7.6l94.8,94.8c2,2,5.6,2,7.6,0l12.4-12.4c2-2,2-5.6,0-7.6
                        L342,219.6C340,217.6,336.4,217.6,334.4,219.6z" />
                            <rect x="326.93" y="263.017" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 452.359 741.4069)"
                                style="fill:#FF7058;" width="105.599" height="28" />
                        </svg>
                    </n-icon>
                    <h2>图书管理系统</h2>
                    <n-menu :options="menuOptions" mode="horizontal" defaultValue="book" v-if="$route.name == 'book'" />
                    <n-menu :options="menuOptions" mode="horizontal" defaultValue="card" v-else-if="$route.name == 'card'" />
                    <n-menu :options="menuOptions" mode="horizontal" defaultValue="borrow" v-else-if="$route.name == 'borrow'" />
                    <n-menu :options="menuOptions" mode="horizontal" v-else />
                </n-gi>
                <n-gi class="reset" style="grid-column: span 4 / span 4; margin-right: 15px;">
                    <n-spin :show="spinShow" stroke="#f43d20">
                        <n-button strong secondary type="error" @click="resetDatabase">
                            重置数据库
                        </n-button>
                    </n-spin>
                </n-gi>
            </n-grid>
        </n-layout-header>
        <n-layout-content>
            <router-view v-if="resetRefresh"></router-view>
        </n-layout-content>
    </n-layout>
</template>

<script>
import { h, ref, nextTick } from "vue";
import { RouterLink } from "vue-router";
import { Book, IdCard, BagAdd } from "@vicons/ionicons5";
import {
    NIcon, NLayout, NGrid, NGi, NLayoutHeader, NLayoutContent,
    NMenu, NButton, NSpin, useDialog, useMessage
} from "naive-ui";
import axios from "axios";

axios.defaults.baseURL = "http://api.yasyakarasu.tech/lib"

function renderIcon(icon) {
    return () => h(NIcon, null, { default: () => h(icon) });
}

const menuOptions = [
    {
        label: () => h(
            RouterLink,
            {
                to: {
                    name: "book",
                }
            },
            { default: () => "图书" }
        ),
        key: "book",
        icon: renderIcon(Book)
    },
    {
        label: () => h(
            RouterLink,
            {
                to: {
                    name: "card"
                }
            },
            { default: () => "借书证" }
        ),
        key: "card",
        icon: renderIcon(IdCard)
    },
    {
        label: () => h(
            RouterLink,
            {
                to: {
                    name: "borrow"
                }
            },
            { default: () => "借阅" }
        ),
        key: "borrow",
        icon: renderIcon(BagAdd)
    }
];

const resetRefresh = ref(true)
const spinShow = ref(false)

export default ({
    setup() {
        const dialog = useDialog()
        const message = useMessage()

        return {
            menuOptions,
            resetRefresh,
            spinShow,
            resetDatabase() {
                dialog.warning({
                    title: '警告',
                    content: '重置数据库将会清空所有数据，是否继续？',
                    positiveText: '确定',
                    negativeText: '取消',
                    onPositiveClick: () => {
                        spinShow.value = true
                        axios.post("/db/reset").then((res) => {
                            if (res.data.code === 0) {
                                message.success("重置成功")
                                spinShow.value = false
                                resetRefresh.value = false
                                nextTick(() => {
                                    resetRefresh.value = true
                                })
                            } else {
                                spinShow.value = false
                                message.error("重置失败")
                            }
                        }).catch(err => {
                            spinShow.value = false
                            message.error(err.response.data.msg)
                        })
                    }
                })
            }
        };
    },
    components: {
        NIcon,
        NLayout,
        NGrid,
        NGi,
        NLayoutHeader,
        NLayoutContent,
        NMenu,
        NButton,
        NSpin
    },
    data() {
        return {
            display: true
        }
    },
    methods: {
        reload() {
            this.display = false
            this.$nextTick(() => {
                this.display = true
            })
        }
    }
});
</script>

<style>
body {
    background-color: #f2f1fb;
}

.n-layout-content {
    box-shadow: inset 0 5px 6px #00152914;
    background-color: #f2f1fb;
    padding: 0 10px;
}

.n-card {
    margin-block: 20px;
}

.menu {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    height: 65px;
    margin-left: 20px;
    gap: 30px;
    white-space: nowrap;
}

.router-link-active{
    color: var(--n-item-text-color-active-hover-horizontal);
}

.reset {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    height: 65px;
    gap: 30px;
}
</style>